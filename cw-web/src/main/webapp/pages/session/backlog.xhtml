<ui:composition template="../../templates/generic.xhtml" xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui">

    <ui:define name="pageContent">
        <h:form id="backlogForm" prependId="false">

            <div id="backlogDiv">
                <p:dataTable id="backlogTable" var="story"
                             value="#{backlogController.fetchStories()}"
                             draggableRows="true"
                             widgetVar="backlogTbl"
                             rowIndexVar="index" selection="#{editionStoryController.selectedStory}"
                             rowKey="#{story.id}"
                             rowStyleClass="#{backlogController.isRemoved(story) ? 'storyRemoved' : null}"
                             selectionMode="single" filteredValue="#{backlogController.storiesFiltered}">
                    <p:ajax event="rowReorder" listener="#{backlogController.onRowReorder}"/>
                    <p:ajax event="rowSelect" update="openButton,removeButton"/>
                    <p:ajax event="rowUnselect" update="openButton,removeButton"/>

                    <p:column style="padding: 0px; width: 4px;">
                        <span class="status_collum_#{backlogController.getStatus(story)}"/>
                    </p:column>

                    <p:column headerText="#{backlog['header.table.project']}"
                              style="width: 50px; text-align: center">
                        <h:outputText value="#{story.project.nameProject}"/>
                    </p:column>

                    <p:column headerText="#{backlog['header.table.subject']}"
                              style="width: 300px; text-align: center" filterBy="#{story.subject}"
                              filterMatchMode="contains">
                        <h:outputText value="#{story.subject}"/>
                    </p:column>

                    <p:column headerText="#{backlog['header.table.code']}" style="width: 100px; text-align: center"
                              filterBy="#{story.code}" filterMatchMode="contains">
                        <h:outputText value="#{story.code}"/>
                    </p:column>

                    <p:column headerText="#{backlog['header.table.branch']}"
                              style="width: 100px; text-align: center" filterBy="#{story.branch}"
                              filterMatchMode="contains">
                        <h:outputText value="#{story.branch}"/>
                    </p:column>

                    <p:column headerText="#{backlog['header.table.area']}" style="width: 50px; text-align: center">
                        <h:outputText value="#{story.projectArea.name}"/>
                    </p:column>

                    <p:column headerText="#{backlog['header.table.author']}"
                              style="width: 100px; text-align: center">
                        <h:outputText value="#{story.author.firstName}"/>
                    </p:column>
                    <f:facet name="header">
                        <p:toolbar>
                            <f:facet name="left">
                                <p:commandButton id="removeButton" styleClass="warning_button" icon="ui-icon-trash"
                                                 value="#{backlog['btn.remove']}"
                                                 update=":backlogForm:backlogTable"
                                                 disabled="#{!editionStoryController.isSelected()}"
                                                 action="#{backlogController.removeStory()}">
                                    <p:confirm message="#{backlog['confirmation.remove.text']}"
                                               icon="ui-icon-alert"/>
                                </p:commandButton>

                                <p:commandButton icon="ui-icon-plus" value="#{backlog['btn.add']}"
                                                 oncomplete="PF('storyCreation').show();"/>

                                <p:commandButton id="openButton" icon="ui-icon-folder-open"
                                                 value="#{backlog['btn.open']}"
                                                 oncomplete="PF('storyDetail').show()"
                                                 disabled="#{!editionStoryController.isSelected()}"
                                                 update=":storyDetail"/>
                            </f:facet>

                            <f:facet name="right">
                                <p:outputPanel>
                                    <p:inputText id="statusFilter" onkeyup="PF('backlogTbl').filter()" style="width:150px" placeholder="Status Da Estoria"/>
                                </p:outputPanel>
                            </f:facet>
                        </p:toolbar>
                    </f:facet>
                </p:dataTable>
            </div>
        </h:form>

        <p:dialog id="storyDetail" widgetVar="storyDetail" modal="true" resizable="false" appendToBody="false">
            <p:outputPanel id="storyDetailPanel">
                <h:form id="storyDetailForm" prependId="false">

                    <div class="story_#{editionStoryController.status}">
                        <h:outputText value="#{backlog['story.status.'.concat(editionStoryController.status)]}"
                                      style="text-align: center; font-size: 30px !important;"/>
                    </div>

                    <p:spacer width="15px"/>

                    <h:panelGrid columns="2">
                        <h:column>
                            <h:outputLabel value="#{backlog['label.story_points']}" for="storyPoints"/>
                        </h:column>

                        <h:column>
                            <p:inputMask mask="9?9" id="storyPoints"
                                         value="#{editionStoryController.storyEdition.storyPoints}" maxlength="2"
                                         size="2" style="width: 20px;"/>
                        </h:column>

                        <h:column>
                            <h:outputLabel value="#{backlog['label.creation_date']}" for="creationDate"/>
                        </h:column>

                        <h:column>
                            <p:calendar id="creationDate" value="#{editionStoryController.storyEdition.creationDate}"
                                        disabled="true" pattern="dd/MM/yyyy HH:mm"/>
                        </h:column>

                        <h:column>
                            <h:outputLabel value="#{backlog['label.code']}" for="code"/>
                        </h:column>

                        <h:column>
                            <p:inputText id="code" value="#{editionStoryController.storyEdition.code}" readonly="true"/>
                        </h:column>

                        <h:column>
                            <h:outputLabel value="#{backlog['label.branch']}" for="branch"/>
                        </h:column>

                        <h:column>
                            <p:inputText id="branch" value="#{editionStoryController.storyEdition.branch}"
                                         requiredMessage="#{messages['mandatory.field']}"/>
                        </h:column>

                        <h:column>
                            <p:message for="branch"/>

                            <h:outputLabel value="#{backlog['label.area']}" for="area"/>
                        </h:column>

                        <h:column>
                            <p:inputText id="area" value="#{editionStoryController.storyEdition.projectArea.name}"
                                         readonly="true" size="68"/>
                        </h:column>

                        <h:column>
                            <h:outputLabel value="#{backlog['label.author']}" for="author"/>
                        </h:column>

                        <h:column>
                            <p:inputText id="author" value="#{editionStoryController.storyEdition.author.fullName}"
                                         readonly="true" size="68"/>
                        </h:column>

                        <h:column>
                            <h:outputLabel value="#{backlog['label.subject']}" for="subject"/>
                        </h:column>

                        <h:column>
                            <p:inputText id="subject" value="#{editionStoryController.storyEdition.subjectChanges}"
                                         requiredMessage="#{messages['mandatory.field']}" required="true" size="68"/>
                            <p:message for="subject"/>
                        </h:column>
                    </h:panelGrid>

                    <p:message for="description"/>
                    <p:inputTextarea id="description"
                                     value="#{editionStoryController.storyEdition.descriptionChanges}" cols="88"
                                     rows="20" requiredMessage="#{messages['mandatory.field']}"
                                     required="true"/>

                    <h:panelGrid columns="4">
                        <p:commandButton id="storyDetailSave" value="#{backlog['btn.save']}"
                                         action="#{editionStoryController.save()}" oncomplete="PF('storyDetail').hide()"
                                         update="storyDetailForm,:backlogForm:backlogTable" icon="ui-icon-disk"/>
                        <p:commandButton id="storyDetailCancel" value="#{backlog['btn.cancel']}"
                                         oncomplete="PF('storyDetail').hide()" icon="ui-icon-arrowreturnthick-1-w"
                                         immediate="true">
                        </p:commandButton>
                        <p:commandButton id="storyStatusAvailable" value="#{backlog['btn.available']}"
                                         action="#{editionStoryController.provide()}"
                                         update="storyDetailForm,:backlogForm:backlogTable" icon="ui-icon-check"
                                         rendered="#{editionStoryController.isPossibleProvide()}">

                            <p:confirm message="#{backlog['confirmation.change_status.text']}"
                                       icon="ui-icon-alert"/>
                        </p:commandButton>

                        <p:commandButton id="storyStatusRestore" value="#{backlog['btn.restore']}"
                                         action="#{editionStoryController.restore()}"
                                         update="storyDetailForm,:backlogForm:backlogTable" icon="ui-icon-check"
                                         rendered="#{editionStoryController.isPossibleRestore()}">
                            <p:confirm message="#{backlog['confirmation.remove.text']}"
                                       icon="ui-icon-alert"/>
                        </p:commandButton>

                        <p:commandButton id="storyVoting" value="#{backlog['btn.voting']}"
                                         rendered="#{editionStoryController.isPossibleVoting()}"
                                         action="#{editionStoryController.voting()}"
                                         icon="ui-icon-note"
                                         immediate="true"/>
                    </h:panelGrid>
                </h:form>
            </p:outputPanel>
        </p:dialog>

        <p:dialog id="storyCreation" widgetVar="storyCreation" modal="true" resizable="false" appendToBody="false">
            <h:form id="createStoryForm" prependId="false">
                <h:panelGrid columns="1">
                    <p:selectOneMenu id="projectNewStory" value="#{creationStoryController.project}"
                                     required="true" requiredMessage="#{messages['mandatory.field']}">
                        <f:selectItem itemLabel="#{backlog['label.story.creation.select_empty']}" itemValue=""/>
                        <p:ajax event="change" execute="@this" update="projectArea"/>
                        <f:selectItems value="#{creationStoryController.projects}" var="projectName"
                                       itemLabel="#{projectName}" itemValue="#{projectName}"/>
                    </p:selectOneMenu>
                    <p:message for="projectNewStory"/>

                    <p:autoComplete id="projectArea" forceSelection="true" dropdown="true" itemLabel="#{area}"
                                    var="area" value="#{creationStoryController.projectArea}"
                                    completeMethod="#{creationStoryController.fetchProjectAreas}" itemValue="#{area}"
                                    required="true" requiredMessage="#{messages['mandatory.field']}"/>
                    <p:message for="projectArea"/>

                    <p:watermark value="#{backlog['label.story.creation.subject']}" for="subjecNewStory"/>
                    <p:inputText id="subjecNewStory" value="#{creationStoryController.storyCreation.subject}"
                                 size="60" required="true" requiredMessage="#{messages['mandatory.field']}"/>
                    <p:message for="subjecNewStory"/>

                    <p:watermark value="#{backlog['label.story.creation.description']}"
                                 for="descriptionNewStory"/>
                    <p:inputTextarea id="descriptionNewStory"
                                     value="#{creationStoryController.storyCreation.description}"
                                     cols="63" rows="20" required="true"
                                     requiredMessage="#{messages['mandatory.field']}"/>
                    <p:message for="descriptionNewStory"/>
                </h:panelGrid>

                <h:panelGrid columns="2">
                    <p:commandButton id="save" value="#{backlog['btn.save']}"
                                     update="@form,:backlogForm:backlogTable"
                                     action="#{creationStoryController.create()}" icon="ui-icon-disk"/>
                    <p:commandButton id="cancel" value="#{backlog['btn.cancel']}"
                                     action="#{creationStoryController.cancel()}"
                                     oncomplete="PF('storyCreation').hide()" icon="ui-icon-arrowreturnthick-1-w"
                                     immediate="true">
                        <p:ajax update="createStoryForm" resetValues="true"/>
                    </p:commandButton>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:confirmDialog global="true" widgetVar="confirmationDialog" modal="true" resizable="false">
            <p:outputPanel>
                <h:panelGrid columns="2">
                    <h:form>
                        <p:commandButton value="#{backlog['btn.save']}" update=":backlogForm:backlogTable"
                                         styleClass="ui-confirmdialog-yes" icon="ui-icon-check"/>
                        <p:commandButton value="#{backlog['btn.cancel']}"
                                         type="button"
                                         styleClass="ui-confirmdialog-no" icon="ui-icon-close"/>
                    </h:form>
                </h:panelGrid>
            </p:outputPanel>
        </p:confirmDialog>

    </ui:define>
</ui:composition>